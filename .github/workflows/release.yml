name: Build WoW Addon Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "ADDON_NAME=LuheyUI" >> "$GITHUB_ENV"

      - name: Package addon
        run: |
          mkdir -p "package/${ADDON_NAME}"

          rsync -a ./ "package/${ADDON_NAME}/" \
            --exclude=".git" \
            --exclude=".gitignore" \
            --exclude=".github" \
            --exclude="dist" \
            --exclude="package" \
            --exclude="*.zip" \
            --exclude="**:Zone.Identifier"

          cd package
          zip -r "../${ADDON_NAME}-${VERSION}.zip" "${ADDON_NAME}"

          echo "Built ZIP with structure:"
          unzip -l "../${ADDON_NAME}-${VERSION}.zip" | head -20

      - name: Create GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          file: ${{ env.ADDON_NAME }}-${{ env.VERSION }}.zip
          asset_name: ${{ env.ADDON_NAME }}-${{ env.VERSION }}.zip
          overwrite: true