name: Build WoW Addon Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "TAG_NAME=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          echo "ADDON_NAME=LuheyUI" >> $GITHUB_ENV

      - name: Create addon zip (WowUp-friendly)
        run: |
          set -euo pipefail
          mkdir -p dist

          # Build a clean staging folder so the ZIP has LuheyUI/ at the root
          rm -rf package
          mkdir -p "package/${ADDON_NAME}"

          # If repo already has LuheyUI/ folder, copy that folder.
          # Otherwise, copy repo root contents into package/LuheyUI excluding git + workflow stuff.
          if [ -d "${ADDON_NAME}" ]; then
            rsync -a "${ADDON_NAME}/" "package/${ADDON_NAME}/" \
              --exclude=".git" \
              --exclude=".github" \
              --exclude="**:Zone.Identifier"
          else
            rsync -a "./" "package/${ADDON_NAME}/" \
              --exclude=".git" \
              --exclude=".github" \
              --exclude="dist" \
              --exclude="package" \
              --exclude="**:Zone.Identifier"
          fi

          cd package
          zip -r "../dist/${ADDON_NAME}-${TAG_NAME}.zip" "${ADDON_NAME}"
          cd ..

          ls -lh dist
          unzip -l "dist/${ADDON_NAME}-${TAG_NAME}.zip" | head -n 50

      - name: Create GitHub Release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: ${{ env.TAG_NAME }}
          files: dist/*.zip
          generate_release_notes: true
